# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Bill Split is a React + TypeScript application that uses AI to analyze receipts and fairly split bills among friends with Venmo integration. The app supports both AI-powered receipt scanning and manual bill creation.

**Live deployment:** https://bill-split-lemon.vercel.app

## Development Commands

```bash
# Start development server (http://localhost:8080)
npm run dev

# Build for production
npm run build

# Build for development (with sourcemaps)
npm run build:dev

# Run linter
npm run lint

# Preview production build locally
npm preview
```

## Architecture

### State Management Pattern

The app uses a **custom hooks architecture** where each major feature domain has its own hook that manages related state and logic:

- **`useBillSplitter`** - Core bill state (billData, itemAssignments, calculations)
- **`usePeopleManager`** - People state (adding, removing, friends list)
- **`useItemEditor`** - Item editing/adding state (edit mode, add mode, validation)
- **`useReceiptAnalyzer`** - Gemini AI integration for receipt analysis
- **`useFileUpload`** - File upload and image preview state
- **`useUserProfile`** - User profile and Firestore operations

These hooks are composed together in `Index.tsx` and props are passed down to components.

### Data Flow

1. **Bill Creation**: User uploads receipt → Gemini AI analyzes → `setBillData()` → OR user manually adds items → `addItem()` creates/updates bill
2. **Item Assignment**: User clicks person badges → `handleItemAssignment()` → Updates `itemAssignments` state
3. **Calculations**: `itemAssignments` + `billData` → `calculatePersonTotals()` → Proportional tax/tip distribution
4. **Venmo Charges**: Person total + assigned items → `generateItemDescription()` → Venmo deep link with itemized note

### Responsive Design Strategy

The app has distinct mobile (<768px) and desktop (≥768px) views:

- **Desktop**: Table-based layout (`BillItemsTable`) with dropdown or badge assignment modes
- **Mobile**: Card-based layout (`BillItemCard`) with badge-only assignment mode
- **Component switching**: `BillItems.tsx` checks `useIsMobile()` and renders appropriate component

### Firebase Integration

- **Authentication**: Google OAuth via `AuthContext` (wraps entire app)
- **Firestore structure**:
  ```
  users/{userId}/
    - venmoId: string
    - friends: [{ name, venmoId }]
  ```
- **Security rules**: Users can only read/write their own document

### Calculation Logic

**Tax and tip are distributed proportionally** based on item subtotals:
```
personSubtotal = sum of (item.price / numberOfPeopleSharingItem)
proportion = personSubtotal / totalAssignedSubtotal
personTax = billData.tax × proportion
personTip = effectiveTip × proportion
personTotal = personSubtotal + personTax + personTip
```

See `src/utils/calculations.ts` for implementation.

### Type System

All types are in `src/types/`:
- **`bill.types.ts`** - BillData, BillItem
- **`person.types.ts`** - Person, UserProfile, VenmoCharge
- **`assignment.types.ts`** - ItemAssignment, AssignmentMode, PersonTotal

Components should always type their props with an interface.

## Key Technical Patterns

### Adding Items (Manual or AI)

Items can be added two ways:
1. **AI**: `analyzeReceipt()` → Gemini extracts items → `setBillData()` with full bill
2. **Manual**: User clicks "Add Item" → `addItem()` → Creates bill if null, or appends to existing

Both paths recalculate `subtotal` and `total` after item changes.

### Venmo Integration

Uses **deep link URL scheme**: `venmo://paycharge?txn=charge&recipients={id}&amount={amount}&note={note}`

The `note` field contains itemized breakdown generated by `generateItemDescription()`:
```
"Restaurant Name: Pizza ($12.00), Soda (split 2 ways) ($3.00)"
```

Fallback to web URL if Venmo app not detected.

### Friends List Autocomplete

When typing in "Add Person" field:
- Filters friends using `startsWith()` (not `includes()`)
- Clicking suggestion automatically adds friend to bill via `addFromFriend()`
- Friends stored in Firestore and synced on component mount

## Environment Variables

Required in `.env`:
```
VITE_GEMINI_API_KEY=
VITE_FIREBASE_API_KEY=
VITE_FIREBASE_AUTH_DOMAIN=
VITE_FIREBASE_PROJECT_ID=
VITE_FIREBASE_STORAGE_BUCKET=
VITE_FIREBASE_MESSAGING_SENDER_ID=
VITE_FIREBASE_APP_ID=
```

## Component Structure

```
src/
├── components/
│   ├── bill/          # Bill items display (table/card + edit/add forms)
│   ├── people/        # People management + friends dialogs
│   ├── profile/       # Profile settings + manage friends
│   ├── receipt/       # Receipt upload UI
│   ├── shared/        # Item assignment badges/dropdowns
│   ├── venmo/         # Venmo charge dialog
│   └── ui/            # shadcn/ui primitives
├── hooks/             # Custom hooks for state management
├── contexts/          # AuthContext for Firebase auth
├── utils/             # Calculations, validation, Venmo helpers
├── services/          # Gemini AI service
└── types/             # TypeScript type definitions
```

## Important Notes

- **Bill state can be null**: Always check `billData` before accessing properties. Bill is created on first item add OR receipt upload.
- **Assignment modes**: Desktop supports both "checkboxes" (badges) and "dropdown" modes. Mobile is always badges.
- **Item IDs**: Generated using `item-${Date.now()}` or `person-${Date.now()}`
- **Firestore undefined**: Never save `undefined` to Firestore - omit the field or use conditional spreading
- **Mobile breakpoint**: 768px (defined in `use-mobile.tsx`)
